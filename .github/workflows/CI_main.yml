name: CI Tests (Conda)

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Mambaforge
        run: |
          curl -L -O https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-Linux-x86_64.sh
          bash Mambaforge-Linux-x86_64.sh -b -p $HOME/mambaforge
          echo "$HOME/mambaforge/bin" >> $GITHUB_PATH
          source $HOME/mambaforge/etc/profile.d/conda.sh
          conda init bash

      - name: Create Conda Environment
        run: |
          source $HOME/mambaforge/etc/profile.d/conda.sh
          mamba env create -f environment.yml
          conda activate tostadas_tests
          which python

      - name: Set up Java (for Nextflow)
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'

      - name: Set up Nextflow
        uses: nf-core/setup-nextflow@v1
        with:
          version: 'latest'

      - name: Install nf-test
        run: |
          wget -qO- https://get.nf-test.com | bash
          sudo mv nf-test /usr/local/bin/

      - name: Run nf-test (Conda)
        run: |
          source $HOME/mambaforge/etc/profile.d/conda.sh
          conda activate tostadas_tests
          nf-test test --ci 

